# ì›Œí¬í”Œë¡œìš°ì˜ ìµœìƒë‹¨ì— ìœ„ì¹˜í•˜ë©°, GitHub Actions UIì˜ ì›Œí¬í”Œë¡œìš° ëª©ë¡ì— í‘œì‹œë  ì´ë¦„ìž…ë‹ˆë‹¤.
# ì´ëª¨ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš°ì™€ ì‹œê°ì ìœ¼ë¡œ êµ¬ë¶„í•©ë‹ˆë‹¤.
name: "ðŸš€ [Backend] Build, Push to ECR & Deploy via Terraform"

# 'run-name'ì€ ê°œë³„ ì‹¤í–‰(Run)ì˜ ì´ë¦„ì„ ë™ì ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
# ì´ë¥¼ í†µí•´ Actions ì‹¤í–‰ ê¸°ë¡ì—ì„œ ê° ë°°í¬ì˜ ëª©ì ì„ í•œëˆˆì— íŒŒì•…í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
# ì˜ˆ: "ðŸš€ Backend Deploy | íŽ˜ë¥´ì†Œë‚˜ ê¸°ëŠ¥ ì¶”ê°€ | by @github_user"
run-name: "ðŸš€ Backend Deploy | ${{ github.event.inputs.run_description }} | by @${{ github.actor }}"

# 'on' ì„¹ì…˜ì€ ì´ ì›Œí¬í”Œë¡œìš°ê°€ ì–¸ì œ ì‹¤í–‰ë ì§€ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
on:
  # 'workflow_dispatch'ëŠ” GitHub UIì—ì„œ "Run workflow" ë²„íŠ¼ì„ ëˆŒëŸ¬ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìžˆê²Œ í•©ë‹ˆë‹¤.
  workflow_dispatch:
    # 'inputs' ì„¹ì…˜ì€ ìˆ˜ë™ ì‹¤í–‰ ì‹œ ì‚¬ìš©ìžë¡œë¶€í„° ë°›ì„ íŒŒë¼ë¯¸í„°ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
    inputs:
      git_ref:
        description: "ë¹Œë“œí•  Git ì°¸ì¡° (ë¸Œëžœì¹˜, íƒœê·¸ ë˜ëŠ” ì»¤ë°‹ SHA)"
        required: true
        default: "main"
      image_tag_suffix:
        description: "ì´ë¯¸ì§€ íƒœê·¸ì— ì¶”ê°€í•  ì ‘ë¯¸ì‚¬ (ì„ íƒ ì‚¬í•­)"
        required: false
        default: ""
      run_description:
        description: "ðŸ’¬ ì´ ë°°í¬ì˜ ëª©ì ì„ ìž…ë ¥í•˜ì„¸ìš” (ì˜ˆ: íŽ˜ë¥´ì†Œë‚˜ ê¸°ëŠ¥ ì¶”ê°€)"
        required: true
        default: "Regular Manual Deployment"

# 'permissions'ëŠ” ì´ ì›Œí¬í”Œë¡œìš°ê°€ GitHub APIì™€ ìƒí˜¸ìž‘ìš©í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ê¶Œí•œì„ ì •ì˜í•©ë‹ˆë‹¤.
permissions:
  id-token: write # AWS OIDC ì¸ì¦ì„ ìœ„í•´ ID í† í°ì„ ë°œê¸‰ë°›ì„ ê¶Œí•œ
  contents: read # ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œë¥¼ ì½ì„(checkout) ê¶Œí•œ

# 'env'ëŠ” ì´ ì›Œí¬í”Œë¡œìš°ì˜ ëª¨ë“  ìž¡(job)ì—ì„œ ê³µí†µì ìœ¼ë¡œ ì‚¬ìš©í•  í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
# GitHub Secretsë¥¼ ì‚¬ìš©í•˜ì—¬ ë¯¼ê°í•œ ì •ë³´ë¥¼ ì•ˆì „í•˜ê²Œ ê´€ë¦¬í•©ë‹ˆë‹¤.
env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REPOSITORY_URL: ${{ secrets.ECR_REPOSITORY_URL }} # FastAPI ì•± ì´ë¯¸ì§€ë¥¼ ì €ìž¥í•  ECR ë¦¬í¬ì§€í† ë¦¬ì˜ ì „ì²´ URL

# 'jobs'ëŠ” ì›Œí¬í”Œë¡œìš°ë¥¼ êµ¬ì„±í•˜ëŠ” ì‹¤ì œ ìž‘ì—… ë‹¨ìœ„ë“¤ì„ ì •ì˜í•©ë‹ˆë‹¤.
jobs:
  # ì²« ë²ˆì§¸ ìž¡: ì½”ë“œë¥¼ ë¹Œë“œí•˜ê³  Docker ì´ë¯¸ì§€ë¥¼ ECRì— í‘¸ì‹œí•©ë‹ˆë‹¤.
  build_and_push_to_ecr:
    name: 1. Build and Push Docker Image to ECR
    runs-on: ubuntu-latest
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code from specified ref
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_ref }} # ì‚¬ìš©ìžê°€ ìž…ë ¥í•œ Git ì°¸ì¡°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

      # 2. ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
      # íƒ€ìž„ìŠ¤íƒ¬í”„ì™€ ì»¤ë°‹ í•´ì‹œë¥¼ ì¡°í•©í•˜ì—¬ ê³ ìœ í•˜ê³  ì¶”ì  ê°€ëŠ¥í•œ ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ë§Œë“­ë‹ˆë‹¤.
      - name: Generate image tag
        id: generate_tag
        run: |
          timestamp_sha=$(date +%Y%m%d%H%M%S)-$(echo $GITHUB_SHA | cut -c1-7)
          suffix="${{ github.event.inputs.image_tag_suffix }}"
          if [ -n "$suffix" ]; then
            echo "tag=${timestamp_sha}-${suffix}" >> $GITHUB_OUTPUT
          else
            echo "tag=${timestamp_sha}" >> $GITHUB_OUTPUT
          fi
        shell: bash

      # 3. ECR URLì—ì„œ ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ ì¶”ì¶œ
      # ì „ì²´ ECR URLì—ì„œ ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ë§Œ ë¶„ë¦¬í•˜ì—¬ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•©ë‹ˆë‹¤.
      - name: Extract ECR Repository Name from URL
        id: extract_repo_name
        run: echo "repo_name=$(echo $ECR_REPOSITORY_URL | cut -d'/' -f2)" >> $GITHUB_OUTPUT
        shell: bash

      # 4. AWS ìžê²© ì¦ëª… ì„¤ì • (OIDC ë°©ì‹)
      # Access Keyë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ì•Šê³ , GitHub Actionsì™€ AWS ê°„ì˜ ì‹ ë¢° ê´€ê³„ë¥¼ í†µí•´
      # ìž„ì‹œ ìžê²© ì¦ëª…ì„ ì•ˆì „í•˜ê²Œ ë°œê¸‰ë°›ìŠµë‹ˆë‹¤.
      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_ARN }} # ì´ ì›Œí¬í”Œë¡œìš°ê°€ ìœ„ìž„ë°›ì„ IAM ì—­í• ì˜ ARN
          aws-region: ${{ env.AWS_REGION }}

      # 5. Amazon ECR ë¡œê·¸ì¸
      # ìœ„ì—ì„œ ì–»ì€ AWS ìžê²© ì¦ëª…ì„ ì‚¬ìš©í•˜ì—¬ ECRì— ë¡œê·¸ì¸í•©ë‹ˆë‹¤.
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 6. Docker ì´ë¯¸ì§€ ë¹Œë“œ, íƒœê·¸ ì§€ì • ë° ECRì— í‘¸ì‹œ
      - name: Build, tag, and push image to Amazon ECR
        id: push_image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY_NAME: ${{ steps.extract_repo_name.outputs.repo_name }}
          IMAGE_TAG: ${{ steps.generate_tag.outputs.tag }}
        run: |
          set -e # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.

          IMAGE_URI_WITH_TAG="$ECR_REGISTRY/$ECR_REPOSITORY_NAME:$IMAGE_TAG"
          LATEST_TAG_URI="$ECR_REGISTRY/$ECR_REPOSITORY_NAME:latest"

          echo "ðŸš€ Building image: $IMAGE_URI_WITH_TAG"
          docker build -t "$IMAGE_URI_WITH_TAG" .

          echo "ðŸ·ï¸ Tagging image as 'latest'..."
          docker tag "$IMAGE_URI_WITH_TAG" "$LATEST_TAG_URI"

          echo "ðŸ“¦ Pushing versioned image to ECR: $IMAGE_TAG"
          docker push "$IMAGE_URI_WITH_TAG"

          echo "ðŸ“¦ Pushing 'latest' tag to ECR..."
          docker push "$LATEST_TAG_URI"

          echo "âœ… Successfully pushed images."

          # ë‹¤ìŒ ìž¡(job)ìœ¼ë¡œ ì´ë¯¸ì§€ URIë¥¼ ì „ë‹¬í•˜ê¸° ìœ„í•´ íŒŒì¼ì— ì €ìž¥í•©ë‹ˆë‹¤.
          printf "%s" "$IMAGE_URI_WITH_TAG" > image_uri.txt

      # 7. ì´ë¯¸ì§€ URIë¥¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      # 'build' ìž¡ê³¼ 'deploy' ìž¡ì€ ë‹¤ë¥¸ ëŸ¬ë„ˆ(runner)ì—ì„œ ì‹¤í–‰ë  ìˆ˜ ìžˆìœ¼ë¯€ë¡œ,
      # ì•„í‹°íŒ©íŠ¸ë¥¼ í†µí•´ íŒŒì¼(image_uri.txt)ì„ ì „ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤.
      - name: Upload image URI as artifact
        uses: actions/upload-artifact@v4
        with:
          name: image-uri-artifact
          path: image_uri.txt

  # ë‘ ë²ˆì§¸ ìž¡: Terraform Cloudì— ë°°í¬ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.
  deploy_via_terraform_cloud:
    name: 2. Trigger Terraform Cloud Deployment
    runs-on: ubuntu-latest
    needs: build_and_push_to_ecr # 'build_and_push_to_ecr' ìž¡ì´ ì„±ê³µí•´ì•¼ ì´ ìž¡ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.

    steps:
      # 1. ì´ì „ ìž¡ì—ì„œ ì—…ë¡œë“œí•œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      - name: Download image URI artifact
        uses: actions/download-artifact@v4
        with:
          name: image-uri-artifact

      # 2. ì•„í‹°íŒ©íŠ¸ íŒŒì¼ì—ì„œ ì´ë¯¸ì§€ URIë¥¼ ì½ì–´ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •
      - name: Read image URI from artifact
        id: set_image_uri_env
        run: |
          TRIMMED_URI=$(cat image_uri.txt | xargs) # ê³µë°± ì œê±°
          echo "NEW_IMAGE_URI_FOR_PAYLOAD=$TRIMMED_URI" >> $GITHUB_ENV
          echo "Image URI for Terraform Cloud: [$TRIMMED_URI]"

      # 3. Terraform Cloudì— ë°°í¬(Run) ìš”ì²­
      - name: Trigger Terraform Cloud Run
        env:
          TFC_API_TOKEN: ${{ secrets.TFC_API_TOKEN }}
          TFC_WORKSPACE_ID: ${{ secrets.TFC_WORKSPACE_ID }}
          TFC_ORGANIZATION_NAME: ${{ secrets.TFC_ORGANIZATION_NAME }}
        run: |
          set -e

          # Terraform Cloud APIì— ë³´ë‚¼ JSON íŽ˜ì´ë¡œë“œ(payload)ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
          # ì´ íŽ˜ì´ë¡œë“œì—ëŠ” ë°°í¬ ë©”ì‹œì§€ì™€, Terraform ë³€ìˆ˜ë¡œ ì „ë‹¬í•  ìƒˆ ì´ë¯¸ì§€ URIê°€ í¬í•¨ë©ë‹ˆë‹¤.
          echo "ðŸ—ï¸ Constructing PAYLOAD for Terraform Cloud API..."
          PAYLOAD=$(jq -n \
            --arg msg "Deploying new image via GitHub Actions: ${NEW_IMAGE_URI_FOR_PAYLOAD}" \
            --arg image_uri_for_tf_var "${NEW_IMAGE_URI_FOR_PAYLOAD}" \
            --arg workspace_id_value "${TFC_WORKSPACE_ID}" \
            '{
              "data": {
                "attributes": {
                  "message": $msg,
                  "is-destroy": false,
                  "variables": [
                    {
                      "key": "custom_fastapi_docker_image",
                      "value": ($image_uri_for_tf_var | tojson),
                      "category": "terraform",
                      "hcl": true,
                      "sensitive": false
                    }
                  ]
                },
                "type": "runs",
                "relationships": {
                  "workspace": {
                    "data": {
                      "type": "workspaces",
                      "id": $workspace_id_value
                    }
                  }
                }
              }
            }')

          # curlì„ ì‚¬ìš©í•˜ì—¬ Terraform Cloud APIì— POST ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
          echo "ðŸ“¡ Sending API Request to Terraform Cloud..."
          API_RESPONSE=$(curl -sS --request POST \
            --header "Authorization: Bearer $TFC_API_TOKEN" \
            --header "Content-Type: application/vnd.api+json" \
            --data "$PAYLOAD" \
            https://app.terraform.io/api/v2/runs)

          # API ì‘ë‹µì„ í™•ì¸í•˜ì—¬ ì„±ê³µ ì—¬ë¶€ë¥¼ íŒë‹¨í•©ë‹ˆë‹¤.
          if echo "$API_RESPONSE" | jq -e .data.id > /dev/null; then
            RUN_ID=$(echo "$API_RESPONSE" | jq -r .data.id)
            echo "âœ… Successfully triggered a new run in Terraform Cloud."
            echo "Terraform Cloud Run ID: $RUN_ID"
            echo "View the run here: https://app.terraform.io/app/${TFC_ORGANIZATION_NAME}/workspaces/${TFC_WORKSPACE_ID}/runs/${RUN_ID}"
          else
            echo "::error:: Failed to trigger a new run in Terraform Cloud."
            echo "API Response: $API_RESPONSE"
            exit 1
          fi
