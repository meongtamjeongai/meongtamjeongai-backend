# ì›Œí¬í”Œë¡œìš°ì˜ UI í‘œì‹œ ì´ë¦„
name: "ğŸš€ [Backend] Build, Push to ECR & Deploy via SSM"

# ë™ì  ì‹¤í–‰ ì´ë¦„ (ë²„ì „ ì •ë³´ ì¶”ê°€)
run-name: "ğŸš€ Backend v${{ github.event.inputs.image_version }} | ${{ github.event.inputs.run_description }} | by @${{ github.actor }}"

on:
  workflow_dispatch:
    inputs:
      git_ref:
        description: "ë¹Œë“œí•  Git ì°¸ì¡° (ë¸Œëœì¹˜, íƒœê·¸ ë˜ëŠ” ì»¤ë°‹ SHA)"
        required: true
        default: "main"
      image_version:
        description: "ì´ë¯¸ì§€ ë²„ì „ íƒœê·¸ (ì˜ˆ: 1.0.0, 1.0.1-hotfix)"
        required: true
        default: "0.0.1" # ê¸°ë³¸ ë²„ì „
      run_description:
        description: "ğŸ’¬ ì´ ë°°í¬ì˜ ëª©ì ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì‚¬ìš©ì UI ê°œì„ )"
        required: true
        default: "Regular Manual Deployment"

# ì›Œí¬í”Œë¡œìš°ì— í•„ìš”í•œ ê¶Œí•œ ì„¤ì •
permissions:
  id-token: write # AWS OIDC ì¸ì¦ì— í•„ìš”
  contents: read  # ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒì— í•„ìš”

# ì›Œí¬í”Œë¡œìš° ì „ì—­ì—ì„œ ì‚¬ìš©í•  í™˜ê²½ ë³€ìˆ˜ (ìƒˆë¡œìš´ ëª…ëª… ê·œì¹™ ì ìš©)
env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REPOSITORY_URL: ${{ secrets.ECR_REPOSITORY_URL }} # ECR ë¦¬í¬ì§€í† ë¦¬ì˜ ì „ì²´ URL
  CONTAINER_NAME: backend-app-container                 # ì»¨í…Œì´ë„ˆ ì´ë¦„ ë³€ê²½
  HOST_PORT: ${{ secrets.BACKEND_HOST_PORT }}
  CONTAINER_PORT: ${{ secrets.BACKEND_CONTAINER_PORT }}

jobs:
  print_run_info:
    name: 0. Print Run Information
    runs-on: ubuntu-latest
    steps:
      - name: Display run parameters
        run: |
          # Job Summaryì— ë°°í¬ ì •ë³´ í‘œì‹œ
          echo "### ğŸš€ Backend App Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| **Git Ref** | \`${{ github.event.inputs.git_ref }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Version** | \`${{ github.event.inputs.image_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Description** | ${{ github.event.inputs.run_description }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | `@${{ github.actor }}` |" >> $GITHUB_STEP_SUMMARY

  build-and-deploy:
    name: Build, Push to ECR, and Deploy to EC2
    runs-on: ubuntu-latest
    needs: print_run_info

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_ref }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # â­ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECRì— ë‘ ê°œì˜ íƒœê·¸ë¡œ í‘¸ì‹œ (URL ì§ì ‘ ì‚¬ìš©)
      - name: Build, tag, and push image to Amazon ECR
        id: build-and-push-image
        env:
          IMAGE_VERSION: ${{ github.event.inputs.image_version }}
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.ECR_REPOSITORY_URL }}:${{ env.IMAGE_VERSION }}
            ${{ env.ECR_REPOSITORY_URL }}:latest

      # â­ï¸ SSM Send-Command ìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì • (ìƒˆë¡œìš´ ë³€ìˆ˜ ì²´ê³„ ì ìš©)
      - name: Deploy to EC2 instance via SSM
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_VERSION: ${{ github.event.inputs.image_version }}
        run: |
          set -e

          # EC2ì—ì„œ ì‹¤í–‰ë  ì…¸ ìŠ¤í¬ë¦½íŠ¸ ì •ì˜
          COMMAND_SCRIPT=$(cat <<'EOF'
          set -e

          # ECR ë¡œê·¸ì¸
          echo ">>> Logging into ECR from EC2 instance..."
          aws ecr get-login-password --region __AWS_REGION__ | sudo docker login --username AWS --password-stdin __ECR_REGISTRY__

          # ìƒˆ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ (ëª…ì‹œì  ë²„ì „ íƒœê·¸ ì‚¬ìš©)
          echo ">>> Pulling new image: __FULL_IMAGE_URI__"
          sudo docker pull __FULL_IMAGE_URI__

          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
          echo ">>> Stopping and removing old container if it exists..."
          if [ $(sudo docker ps -q -f name=__CONTAINER_NAME__) ]; then sudo docker stop __CONTAINER_NAME__; fi
          if [ $(sudo docker ps -aq -f name=__CONTAINER_NAME__) ]; then sudo docker rm __CONTAINER_NAME__; fi

          # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ëª…ì‹œì  ë²„ì „ íƒœê·¸ ì‚¬ìš©)
          echo ">>> Starting new container..."
          sudo docker run -d \
            --name __CONTAINER_NAME__ \
            -p __HOST_PORT__:__CONTAINER_PORT__ \
            --restart always \
            __FULL_IMAGE_URI__

          # ë¶ˆí•„ìš”í•œ Docker ì´ë¯¸ì§€ ì •ë¦¬
          echo ">>> Pruning old docker images..."
          sudo docker image prune -af

          echo "âœ… Deployment script finished successfully on EC2."
          EOF
          )

          # í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì‹¤ì œ ê°’ìœ¼ë¡œ ì¹˜í™˜
          FULL_IMAGE_URI="${ECR_REPOSITORY_URL}:${IMAGE_VERSION}"
          COMMAND_SCRIPT="${COMMAND_SCRIPT//__AWS_REGION__/${AWS_REGION}}"
          COMMAND_SCRIPT="${COMMAND_SCRIPT//__ECR_REGISTRY__/${ECR_REGISTRY}}"
          COMMAND_SCRIPT="${COMMAND_SCRIPT//__FULL_IMAGE_URI__/${FULL_IMAGE_URI}}"
          COMMAND_SCRIPT="${COMMAND_SCRIPT//__CONTAINER_NAME__/${CONTAINER_NAME}}"
          COMMAND_SCRIPT="${COMMAND_SCRIPT//__HOST_PORT__/${HOST_PORT}}"
          COMMAND_SCRIPT="${COMMAND_SCRIPT//__CONTAINER_PORT__/${CONTAINER_PORT}}"

          # SSM íŒŒë¼ë¯¸í„° ìƒì„± ë° ì „ì†¡
          SSM_PARAMETERS=$(jq -n --arg script "$COMMAND_SCRIPT" '{ "commands": ($script | split("\n")) }')

          echo ">>> Sending deployment command to EC2 instance via SSM..."
          aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy image version ${{ env.IMAGE_VERSION }} via GitHub Actions" \
            --parameters "$SSM_PARAMETERS"