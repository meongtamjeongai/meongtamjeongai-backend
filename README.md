# ğŸ•µï¸â€â™‚ï¸ ë©íƒì • ë°±ì—”ë“œ ì„œë²„

## ë©íƒì • ì˜ ëª¨ë“  ì„œë²„ ê¸°ëŠ¥ì„ ë‹´ë‹¹í•˜ëŠ” FastAPI ê¸°ë°˜ ë°±ì—”ë“œ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.

---
## âœ¨ ì£¼ìš” ê¸°ëŠ¥ (Key Features)

| ê¸°ëŠ¥ ë¶„ë¥˜ | ì„¤ëª… | ì‚¬ìš© ê¸°ìˆ  |
| :--- | :--- | :--- |
| ğŸš€ **API ì„œë²„** | ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ í†µí•´ ë†’ì€ ì„±ëŠ¥ì„ ì œê³µí•˜ëŠ” API ì„œë²„ë¥¼ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤. | ![FastAPI](https://img.shields.io/badge/FastAPI-009688?style=for-the-badge&logo=fastapi) ![Gunicorn](https://img.shields.io/badge/Gunicorn-499848?style=for-the-badge&logo=gunicorn) ![Uvicorn](https://img.shields.io/badge/Uvicorn-2d7ff9?style=for-the-badge&logo=uvicorn) |
| ğŸ’¬ **AI ì±„íŒ…** | ì‚¬ìš©ìì™€ì˜ ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™” ë° ë™ì  í”¼ì‹± ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤. | ![Google Gemini](https://img.shields.io/badge/Google%20Gemini-8E77F0?style=for-the-badge&logo=google-gemini&logoColor=white) |
| ğŸ” **ì¸ì¦** | ë‹¤ì–‘í•œ í´ë¼ì´ì–¸íŠ¸ì™€ ì‚¬ìš©ìë¥¼ ìœ„í•œ ìœ ì—°í•˜ê³  ì•ˆì „í•œ ì¸ì¦ ì‹œìŠ¤í…œì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤. | ![JWT](https://img.shields.io/badge/JWT-000000?style=for-the-badge&logo=jsonwebtokens) ![Firebase](https://img.shields.io/badge/Firebase-FFCA28?style=for-the-badge&logo=firebase) ![Naver](https://img.shields.io/badge/Naver-03C75A?style=for-the-badge&logo=naver&logoColor=white) ![Kakao](https://img.shields.io/badge/Kakao-FEE500?style=for-the-badge&logo=kakao&logoColor=black) ![Guest](https://img.shields.io/badge/Guest-90A4AE?style=for-the-badge&logo=ghost) |
| ğŸ—ƒï¸ **ë°ì´í„° ê´€ë¦¬** | ORMê³¼ ë§ˆì´ê·¸ë ˆì´ì…˜ ë„êµ¬ë¥¼ í†µí•´ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤. | ![PostgreSQL](https://img.shields.io/badge/PostgreSQL-4169E1?style=for-the-badge&logo=postgresql&logoColor=white) ![SQLAlchemy](https://img.shields.io/badge/SQLAlchemy-D71F00?style=for-the-badge&logo=sqlalchemy) ![Alembic](https://img.shields.io/badge/Alembic-4E85A9?style=for-the-badge&logo=alembic) |
| ğŸ³ **ê°œë°œ/ì‹¤í–‰ í™˜ê²½** | ê°œë°œ ë° ë°°í¬ í™˜ê²½ì„ ì»¨í…Œì´ë„ˆí™”í•˜ì—¬ ì¼ê´€ì„±ì„ ìœ ì§€í•˜ê³  ì´ì‹ì„±ì„ ë†’ì˜€ìŠµë‹ˆë‹¤. | ![Docker](https://img.shields.io/badge/Docker-2496ED?style=for-the-badge&logo=docker&logoColor=white) ![Docker Compose](https://img.shields.io/badge/Docker%20Compose-2496ED?style=for-the-badge&logo=docker&logoColor=white) ![Dev Containers](https://img.shields.io/badge/Dev%20Containers-007ACC?style=for-the-badge&logo=visualstudiocode) |
| âš™ï¸ **ë°°í¬ (CD)** | GitHub Actionsë¥¼ í†µí•´ í´ë¼ìš°ë“œ ì¸í”„ë¼ì— ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìë™ ë°°í¬í•©ë‹ˆë‹¤. | ![GitHub Actions](https://img.shields.io/badge/GitHub%20Actions-2088FF?style=for-the-badge&logo=githubactions) |
| â˜ï¸ **í´ë¼ìš°ë“œ ì¸í”„ë¼** | í™•ì¥ ê°€ëŠ¥í•˜ê³  ì•ˆì •ì ì¸ ì„œë¹„ìŠ¤ ìš´ì˜ì„ ìœ„í•´ AWS í´ë¼ìš°ë“œë¥¼ í™œìš©í•©ë‹ˆë‹¤. | ![AWS EC2](https://img.shields.io/badge/AWS%20EC2-FF9900?style=for-the-badge&logo=amazon-ec2&logoColor=white) ![AWS S3](https://img.shields.io/badge/AWS%20S3-FF9900?style=for-the-badge&logo=amazon-s3&logoColor=white) ![AWS ECR](https://img.shields.io/badge/AWS%20ECR-FF9900?style=for-the-badge&logo=amazon-ecr&logoColor=white) ![AWS SSM](https://img.shields.io/badge/AWS%20SSM-FF9900?style=for-the-badge&logo=aws-systems-manager&logoColor=white) |
| ğŸ‘¨â€ğŸ’» **ê´€ë¦¬ì ê¸°ëŠ¥** | ì„œë¹„ìŠ¤ì˜ ì£¼ìš” ë°ì´í„°(ì‚¬ìš©ì, ëŒ€í™” ë“±)ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” APIë¥¼ ì œê³µí•©ë‹ˆë‹¤. | ![FastAPI](https://img.shields.io/badge/FastAPI-009688?style=for-the-badge&logo=fastapi) |
---

## ğŸ“Š ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨ (Architecture Diagram)

```mermaid
graph TD
    %% Tiers & Nodes
    subgraph "ğŸ“± Client Tier"
        Client[fa:fa-user Client]
    end

    subgraph "âš™ï¸ Presentation Tier"
        APILayer("<b>API Layer</b><br>/api/v1/endpoints")
    end

    subgraph "ğŸ§  Business Logic Tier"
        ServiceLayer("<b>Service Layer</b><br>/services")
    end

    subgraph "ğŸ’¾ Data Access Tier"
        CRUDLayer("<b>CRUD Layer</b><br>/crud")
    end

    subgraph "â˜ï¸ External & Database Tier"
        Database[fa:fa-database PostgreSQL DB]
        GeminiAPI[fa:fa-robot Google Gemini API]
        S3Storage[fa:fa-box-open AWS S3 Storage]
    end

    %% Request Flow (Solid)
    Client -- "Request" --> APILayer
    APILayer --> ServiceLayer
    ServiceLayer --> CRUDLayer
    ServiceLayer -- "Call" --> GeminiAPI
    ServiceLayer -- "Call" --> S3Storage
    CRUDLayer --> Database

    %% Response Flow (Dotted)
    Database -.->|"Data"| CRUDLayer
    CRUDLayer -.->|"Data"| ServiceLayer
    GeminiAPI -.->|"Response"| ServiceLayer
    S3Storage -.->|"Data"| ServiceLayer
    ServiceLayer -.->|"Data"| APILayer
    APILayer -.->|"Response"| Client
```

---

## ğŸŒ³ í´ë” êµ¬ì¡° (Directory Structure)

```
meongtamjeongai-backend/
â”œâ”€â”€ ğŸ“‚ app/                  #  FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ í•µì‹¬ ë¡œì§
â”‚   â”œâ”€â”€ ğŸ“‚ api/               # API ì—”ë“œí¬ì¸íŠ¸ ë° ë¼ìš°íŒ…
â”‚   â”œâ”€â”€ ğŸ“‚ core/              # í•µì‹¬ ì„¤ì •, ë³´ì•ˆ, ì˜ˆì™¸ ì²˜ë¦¬
â”‚   â”œâ”€â”€ ğŸ“‚ crud/              # ë°ì´í„°ë² ì´ìŠ¤ CRUD(Create, Read, Update, Delete) í•¨ìˆ˜
â”‚   â”œâ”€â”€ ğŸ“‚ db/                # ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜ ê´€ë¦¬
â”‚   â”œâ”€â”€ ğŸ“‚ models/            # SQLAlchemy DB ëª¨ë¸(í…Œì´ë¸”) ì •ì˜
â”‚   â”œâ”€â”€ ğŸ“‚ schemas/           # Pydantic ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬ ìŠ¤í‚¤ë§ˆ
â”‚   â”œâ”€â”€ ğŸ“‚ services/          # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬
â”‚   â””â”€â”€ ğŸ“„ main.py            # FastAPI ì•±ì˜ ë©”ì¸ ì§„ì…ì 
â”œâ”€â”€ ğŸ“‚ alembic/               # Alembic ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ê´€ë¦¬
â”‚   â””â”€â”€ ğŸ“‚ versions/          # DB ë³€ê²½ ì´ë ¥ ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ ğŸ“‚ .github/               # GitHub Actions CI/CD ì›Œí¬í”Œë¡œìš°
â”œâ”€â”€ ğŸ³ Dockerfile             # í”„ë¡œë•ì…˜ìš© Docker ì´ë¯¸ì§€ ë¹Œë“œ ì„¤ê³„ë„
â”œâ”€â”€ ğŸ³ docker-compose.yml     # ë¡œì»¬ ê°œë°œ í™˜ê²½ êµ¬ì„± (ì•± + DB)
â”œâ”€â”€ ğŸ“œ requirements.in        # í”„ë¡œì íŠ¸ ì£¼ìš” íŒŒì´ì¬ ì˜ì¡´ì„± ëª©ë¡
â””â”€â”€ ğŸ“œ requirements.txt       # ë²„ì „ì´ ê³ ì •ëœ ì „ì²´ ì˜ì¡´ì„± ëª©ë¡
```

---

## ğŸ› ï¸ ì£¼ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬ ë° ê¸°ìˆ  ìŠ¤íƒ

| ë¶„ë¥˜ | ë¼ì´ë¸ŒëŸ¬ë¦¬ / ë„êµ¬ | ì—­í•  ë° ì‚¬ìš© ì´ìœ  |
| :--- | :--- | :--- |
| **ì›¹ í”„ë ˆì„ì›Œí¬** | `FastAPI` | ê³ ì„±ëŠ¥ ë¹„ë™ê¸° ì›¹ í”„ë ˆì„ì›Œí¬. API ê°œë°œ ìƒì‚°ì„±ê³¼ ì„±ëŠ¥ì„ ìœ„í•´ ì„ íƒí–ˆìŠµë‹ˆë‹¤. |
| **ì›¹ ì„œë²„** | `Gunicorn`, `Uvicorn` | `Gunicorn`ì´ `Uvicorn` ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ë¥¼ ê´€ë¦¬í•˜ëŠ” í‘œì¤€ í”„ë¡œë•ì…˜ êµ¬ì„±ìœ¼ë¡œ, ì•ˆì •ì„±ê³¼ í™•ì¥ì„±ì„ í™•ë³´í•©ë‹ˆë‹¤. |
| **ë°ì´í„°ë² ì´ìŠ¤** | `SQLAlchemy` | íŒŒì´ì¬ ORMì˜ í‘œì¤€. íŒŒì´ì¬ ì½”ë“œë¡œ DBë¥¼ ê°ì²´ ì§€í–¥ì ìœ¼ë¡œ ë‹¤ë£¨ê¸° ìœ„í•´ ì‚¬ìš©í•©ë‹ˆë‹¤. |
| | `Alembic` | `SQLAlchemy` ê¸°ë°˜ì˜ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ë„êµ¬. DB ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì´ë ¥ì„ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤. |
| | `asyncpg` | `PostgreSQL`ì„ ìœ„í•œ ê³ ì„±ëŠ¥ ë¹„ë™ê¸° ë“œë¼ì´ë²„. `SQLAlchemy`ì™€ í•¨ê»˜ ë¹„ë™ê¸° DB ì‘ì—…ì„ ìœ„í•´ ì‚¬ìš©í•©ë‹ˆë‹¤. |
| **ë°ì´í„° ìœ íš¨ì„±**| `Pydantic` | API ìš”ì²­/ì‘ë‹µ ë°ì´í„°ì˜ ìœ íš¨ì„± ê²€ì‚¬ ë° ì„¤ì • ê´€ë¦¬ë¥¼ ìœ„í•´ ì‚¬ìš©í•©ë‹ˆë‹¤. `FastAPI`ì˜ í•µì‹¬ ìš”ì†Œì…ë‹ˆë‹¤. |
| **ì¸ì¦/ë³´ì•ˆ** | `python-jose`, `passlib` | `JWT` í† í° ìƒì„± ë° ê²€ì¦, ë¹„ë°€ë²ˆí˜¸ í•´ì‹± ë“± ë³´ì•ˆ ê´€ë ¨ ê¸°ëŠ¥ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤. |
| **ì™¸ë¶€ ì—°ë™** | `google-genai` | Google Gemini AI ëª¨ë¸ê³¼ì˜ ìƒí˜¸ì‘ìš©ì„ ìœ„í•œ ê³µì‹ Python SDKì…ë‹ˆë‹¤. |
| | `firebase-admin` | Firebase ì„œë¹„ìŠ¤(ì¸ì¦ ë“±)ì™€ ì„œë²„ ê°„ í†µì‹ ì„ ìœ„í•œ Python SDKì…ë‹ˆë‹¤. |
| | `boto3` | AWS ì„œë¹„ìŠ¤(S3, SSM ë“±)ë¥¼ íŒŒì´ì¬ ì½”ë“œë¡œ ì œì–´í•˜ê¸° ìœ„í•œ ê³µì‹ SDKì…ë‹ˆë‹¤. |
| | `httpx` | ì™¸ë¶€ API(ì†Œì…œ ë¡œê·¸ì¸, Gemini ë“±)ì™€ í†µì‹ í•˜ê¸° ìœ„í•œ ìµœì‹  ë¹„ë™ê¸° HTTP í´ë¼ì´ì–¸íŠ¸ì…ë‹ˆë‹¤. |
| **API ë¬¸ì„œ** | `scalar-fastapi` | í˜„ëŒ€ì ì´ê³  ì‚¬ìš©í•˜ê¸° í¸ë¦¬í•œ API ë¬¸ì„œë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•©ë‹ˆë‹¤. |
| **íŒŒì¼ ì²˜ë¦¬** | `python-multipart` | `FastAPI`ì—ì„œ multipart/form-data í˜•ì‹ì˜ íŒŒì¼ ì—…ë¡œë“œë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤. |
| | `Pillow` | ì´ë¯¸ì§€ì˜ MIME íƒ€ì… í™•ì¸ ë“± ì„œë²„ ì¸¡ì—ì„œ ê°„ë‹¨í•œ ì´ë¯¸ì§€ ì²˜ë¦¬ë¥¼ ìœ„í•´ ì‚¬ìš©í•©ë‹ˆë‹¤. |
| **ì„±ëŠ¥ í–¥ìƒ** | `uvloop` | `asyncio` ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ëŒ€ì²´í•˜ì—¬ ë” ë†’ì€ ì„±ëŠ¥ì„ ë‚´ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬. (Linux/macOS í™˜ê²½ì—ì„œ ì ìš©) |

---

## ğŸ”¬ ì£¼ìš” í•µì‹¬ ê¸°ëŠ¥ ë° ì½”ë“œ

### 1. ë¹„ë™ê¸° AI ì±„íŒ… ì‘ë‹µ ì²˜ë¦¬ íë¦„

ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ë³´ëƒˆì„ ë•Œ, ì„œë²„ ë‚´ë¶€ì—ì„œ Gemini AI APIì™€ ìƒí˜¸ì‘ìš©í•˜ì—¬ êµ¬ì¡°í™”ëœ ì‘ë‹µì„ ë°›ì•„ ì‚¬ìš©ìì—ê²Œ ì „ë‹¬í•˜ê¸°ê¹Œì§€ì˜ ê³¼ì •ì€ ì´ í”„ë¡œì íŠ¸ì˜ í•µì‹¬ ê¸°ëŠ¥ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. ì „ì²´ ê³¼ì •ì€ ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬ë˜ì–´ ë†’ì€ ì„±ëŠ¥ì„ ë³´ì¥í•©ë‹ˆë‹¤.

**ì²˜ë¦¬ ìˆœì„œ ë‹¤ì´ì–´ê·¸ë¨**
```mermaid
sequenceDiagram
    participant U as ğŸ“± User
    participant A as âš™ï¸ API Layer<br>(messages.py)
    participant S as ğŸ§  Service Layer<br>(message_service.py)
    participant G as â˜ï¸ Gemini Service<br>(gemini_service.py)
    participant D as ğŸ’¾ DB (CRUD)

    U->>+A: POST /conversations/{id}/messages (ë©”ì‹œì§€ ì „ì†¡)
    A->>+S: send_new_message(message_in) í˜¸ì¶œ
    S->>+D: 1. ì´ì „ ëŒ€í™” ë‚´ì—­(History) ì¡°íšŒ
    D-->>-S: ëŒ€í™” ë‚´ì—­ ë°˜í™˜
    S->>+G: 2. get_chat_response() í˜¸ì¶œ<br>(ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ + ëŒ€í™” ë‚´ì—­ + ìƒˆ ë©”ì‹œì§€)
    G-->>-S: 3. êµ¬ì¡°í™”ëœ AI ì‘ë‹µ (JSON) ë°˜í™˜
    S->>+D: 4. ì‚¬ìš©ì ë©”ì‹œì§€ DBì— ì €ì¥
    D-->>-S: ì €ì¥ëœ ì‚¬ìš©ì ë©”ì‹œì§€ ê°ì²´
    S->>+D: 5. AI ì‘ë‹µ ë©”ì‹œì§€ DBì— ì €ì¥
    D-->>-S: ì €ì¥ëœ AI ë©”ì‹œì§€ ê°ì²´
    S-->>-A: ìµœì¢… ì‘ë‹µ ê°ì²´ (ChatMessageResponse) ë°˜í™˜
    A-->>-U: HTTP 201 Created (AI ì‘ë‹µ í¬í•¨)
```

### í•µì‹¬ ì½”ë“œ: send_new_message()

```
# app/services/message_service.py

class MessageService:
    # ... (ì´ˆê¸°í™” ë° ë‹¤ë¥¸ ë©”ì†Œë“œ ìƒëµ)

    async def send_new_message(
        self, conversation_id: int, message_in: MessageCreate, current_user: User
    ) -> ChatMessageResponse:
        # 1. ëŒ€í™”ë°© ì†Œìœ ê¶Œ ë° ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        db_conversation = await self.get_conversation_for_user(conversation_id, current_user)

        # 2. DBì—ì„œ ì´ì „ ëŒ€í™” ë‚´ì—­ì„ ë¨¼ì € ë¶ˆëŸ¬ì˜´
        history = await crud_message.get_messages_by_conversation(
            self.db, conversation_id=conversation_id, limit=None, sort_asc=True
        )

        # 3. Gemini AIì— ì‘ë‹µ ìš”ì²­
        try:
            gemini_response, _ = await self.gemini_service.get_chat_response(
                system_prompt=db_conversation.persona.system_prompt,
                history=history,
                user_message=message_in.content or "",
                phishing_case=db_conversation.applied_phishing_case,
                # ... (ì´ë¯¸ì§€ ì²˜ë¦¬ ë“± ê¸°íƒ€ íŒŒë¼ë¯¸í„°)
            )
        except Exception as e:
            # ... (ì˜¤ë¥˜ ì²˜ë¦¬)

        # 4. ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ DBì— ì €ì¥
        user_db_message = await self.save_user_message(conversation_id, message_in)

        # 5. AI ì‘ë‹µ ë©”ì‹œì§€ë¥¼ DBì— ì €ì¥
        ai_db_message = await self.save_ai_message(conversation_id, gemini_response)

        # 6. ìµœì¢… ì‘ë‹µ ê°ì²´ êµ¬ì„± ë° ë°˜í™˜
        return ChatMessageResponse(
            user_message=MessageResponse.from_orm(user_db_message),
            ai_message=MessageResponse.from_orm(ai_db_message),
            suggested_user_questions=gemini_response.suggested_user_questions,
            # ... (ê¸°íƒ€ ì‘ë‹µ í•„ë“œ)
        )
```

### 2. í†µí•© ì¸ì¦ ë° ìœ ì—°í•œ ê¶Œí•œ ê´€ë¦¬

ì´ í”„ë¡œì íŠ¸ëŠ” ë‹¤ì–‘í•œ ì¸ì¦ ë°©ì‹ì„ í†µí•©ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ê³ , API ì—”ë“œí¬ì¸íŠ¸ë³„ë¡œ ì„¸ë°€í•œ ì ‘ê·¼ ì œì–´ë¥¼ êµ¬í˜„í•˜ì—¬ ë³´ì•ˆì„±ê³¼ ìœ ì—°ì„±ì„ ëª¨ë‘ í™•ë³´í–ˆìŠµë‹ˆë‹¤.

**ì¸ì¦ ì²˜ë¦¬ íë¦„ ë‹¤ì´ì–´ê·¸ë¨**

ì„œë²„ëŠ” í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ ì¢…ë¥˜ì— ë”°ë¼ ê°ê¸° ë‹¤ë¥¸ ì¸ì¦ ë°©ì‹ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.

1.  **ë‚´ë¶€ API ì¸ì¦**: JWT ë˜ëŠ” API í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ ë‚´ë¶€ ìì›ì— ì ‘ê·¼í•©ë‹ˆë‹¤.
2.  **ì†Œì…œ ë¡œê·¸ì¸ ì¸ì¦**: ë„¤ì´ë²„/ì¹´ì¹´ì˜¤ ë“± ì™¸ë¶€ OAuth ì œê³µìë¡œë¶€í„° ë°›ì€ í† í°ìœ¼ë¡œ ì‚¬ìš©ìë¥¼ ì¸ì¦í•˜ê³  ì„œë²„ì˜ JWTë¥¼ ë°œê¸‰í•©ë‹ˆë‹¤.

```mermaid
sequenceDiagram
    participant C as ğŸ“± Client
    participant A as âš™ï¸ API Endpoint
    participant L as ğŸ” Auth Logic
    participant DB as ğŸ’¾ Database
    participant Ext as â˜ï¸ External Auth

    alt ë‚´ë¶€ API ì¸ì¦ (JWT / API Key)
        C->>+A: API ìš”ì²­ (Headerì— JWT/API Key í¬í•¨)
        Note over A: Depends(HasScope) ì‹¤í–‰
        A->>+L: ì‚¬ìš©ì ë° ê¶Œí•œ ì •ë³´ ìš”ì²­
        L-->>-A: (User, Scopes) ë°˜í™˜
        Note over A: ê¶Œí•œ í™•ì¸ í›„ ë¡œì§ ì‹¤í–‰
        A-->>-C: API ì‘ë‹µ
    end

    alt ì†Œì…œ ë¡œê·¸ì¸ (ë„¤ì´ë²„/ì¹´ì¹´ì˜¤)
        C->>+A: POST /social/{provider}/token<br>(Headerì— Naver/Kakao Access Token í¬í•¨)
        A->>+L: ì†Œì…œ ë¡œê·¸ì¸ ìš”ì²­
        L->>+Ext: 1. ì‚¬ìš©ì ì •ë³´ ìš”ì²­<br>(Naver/Kakao API)
        Ext-->>-L: 2. ì‚¬ìš©ì í”„ë¡œí•„ ë°˜í™˜
        L->>+DB: 3. ì‚¬ìš©ì ì¡°íšŒ ë˜ëŠ” ìƒì„± (get_or_create_social_user)
        DB-->>-L: 4. ì„œë²„ ë‚´ë¶€ User ê°ì²´ ë°˜í™˜
        L-->>-A: 5. ì„œë²„ìš© JWT (Access/Refresh) ìƒì„± ë° ë°˜í™˜
        A-->>-C: ì„œë²„ JWT ì‘ë‹µ
    end

    alt Firebase ì¸ì¦
        C->>+A: POST /auth/firebase/token<br>(Firebase ID Token í¬í•¨)
        A->>+L: Firebase ë¡œê·¸ì¸ ìš”ì²­
        L->>+Ext: 1. í† í° ê²€ì¦ (Firebase Admin SDK)
        Ext-->>-L: 2. ê²€ì¦ëœ ì‚¬ìš©ì ì •ë³´ ë°˜í™˜
        L->>+DB: 3. ì‚¬ìš©ì ì¡°íšŒ ë˜ëŠ” ìƒì„±
        DB-->>-L: 4. ì„œë²„ ë‚´ë¶€ User ê°ì²´ ë°˜í™˜
        L-->>-A: 5. ì„œë²„ìš© JWT (Access/Refresh) ìƒì„± ë° ë°˜í™˜
        A-->>-C: ì„œë²„ JWT ì‘ë‹µ
    end
```

### í•µì‹¬ ì½”ë“œ: get_or_create_social_user

ë„¤ì´ë²„/ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë“± ì¼ë°˜ì ì¸ ì†Œì…œ ë¡œê·¸ì¸ ì²˜ë¦¬ ì‹œ, AuthServiceì˜ get_or_create_social_user ë©”ì†Œë“œê°€ ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ í•¨ìˆ˜ëŠ” ì†Œì…œ í”Œë«í¼ì—ì„œ ì–»ì–´ì˜¨ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìš°ë¦¬ ì„œë¹„ìŠ¤ì˜ ì‚¬ìš©ìë¥¼ ì¡°íšŒí•˜ê±°ë‚˜, ì—†ëŠ” ê²½ìš° ìƒˆë¡œ ìƒì„±í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

```
# app/services/auth_service.py

class AuthService:
    # ...

    async def get_or_create_social_user(
        self,
        *,
        provider: SocialProvider,
        provider_user_id: str,
        email: Optional[str],
        username: Optional[str],
    ) -> User:
        """
        ì†Œì…œ ë¡œê·¸ì¸ ì •ë³´ë¥¼ ë°›ì•„ ì‚¬ìš©ìë¥¼ ì¡°íšŒí•˜ê±°ë‚˜ ìƒì„±í•©ë‹ˆë‹¤.
        """
        # 1. (ì œê³µì, ì œê³µì ID)ë¡œ ê¸°ì¡´ ì†Œì…œ ê³„ì • ì¡°íšŒ
        social_account = await crud_social_account.get_social_account_by_provider_and_id(
            self.db, provider=provider, provider_user_id=provider_user_id
        )
        if social_account:
            return social_account.user

        # 2. ì†Œì…œ ê³„ì •ì´ ì—†ìœ¼ë©´, ì´ë©”ì¼ë¡œ ê¸°ì¡´ ì‚¬ìš©ì ì¡°íšŒ
        user = None
        if email:
            user = await crud_user.get_user_by_email(self.db, email=email)

        # 3. ì´ë©”ì¼ë¡œë„ ì‚¬ìš©ìê°€ ì—†ìœ¼ë©´, ì‹ ê·œ ì‚¬ìš©ì ìƒì„±
        if not user:
            user_in = UserCreate(email=email, username=username)
            user = await crud_user.create_user(self.db, user_in=user_in)

        # 4. ìƒˆë¡œ ì–»ì€ User ì •ë³´ì— ì†Œì…œ ê³„ì • ì •ë³´ ì—°ê²°
        social_account_in = SocialAccountCreate(
            provider=provider, provider_user_id=provider_user_id
        )
        await crud_social_account.create_social_account(
            self.db, social_account_in=social_account_in, user_id=user.id
        )

        return user
```
